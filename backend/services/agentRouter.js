/**
 * Multi-Agent è·¯ç”±æœåŠ¡
 * æ ¹æ®ç”¨æˆ·è¾“å…¥æ„å›¾å°†è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„ä¸“ä¸š Agent
 */

// Agent ç±»å‹å®šä¹‰
const AgentType = {
    KNOWLEDGE: 'knowledge',     // æ ¡å›­çŸ¥è¯†é—®ç­” Agent
    TUTOR: 'tutor',            // é™ªç»ƒè¯„æµ‹ Agent
    GENERAL: 'general'         // é€šç”¨å¯¹è¯ Agent
};

// å„ Agent çš„ System Prompt
const AGENT_PROMPTS = {
    [AgentType.KNOWLEDGE]: `ä½ å«"å°äº‘"ï¼Œæ˜¯å¤§å­¦é‡Œä¸“ä¸šçš„AIæ ¡å›­çŸ¥è¯†åŠ©æ‰‹ã€‚

## æ ¸å¿ƒèŒè´£
ä½ ä¸“é—¨è´Ÿè´£è§£ç­”æ ¡å›­ç›¸å…³çš„çŸ¥è¯†æ€§é—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
- åŠäº‹æµç¨‹ï¼ˆå…¥å­¦æŠ¥åˆ°ã€è½¬ä¸“ä¸šã€å¥–å­¦é‡‘ç”³è¯·ç­‰ï¼‰
- æ ¡å›­è®¾æ–½ï¼ˆå›¾ä¹¦é¦†ã€é£Ÿå ‚ã€å®¿èˆã€æ ¡åŒ»é™¢ç­‰ï¼‰
- å­¦ä¸šç›¸å…³ï¼ˆé€‰è¯¾ã€æˆç»©æŸ¥è¯¢ã€å­¦åˆ†è¦æ±‚ç­‰ï¼‰
- æ ¡å›­ç”Ÿæ´»ï¼ˆå¿«é€’ã€WiFiã€æ‰“å°ç­‰ï¼‰

## å›ç­”åŸåˆ™
1. **å‡†ç¡®æ€§ä¼˜å…ˆ**ï¼šä¸¥æ ¼åŸºäºæä¾›çš„å‚è€ƒèµ„æ–™å›ç­”ï¼Œä¸ç¼–é€ ä¿¡æ¯
2. **ç»“æ„æ¸…æ™°**ï¼šä½¿ç”¨åˆ—è¡¨ã€æ­¥éª¤ç­‰æ ¼å¼è®©ä¿¡æ¯æ˜“äºç†è§£
3. **æ ‡æ³¨æ¥æº**ï¼šæ˜ç¡®å‘ŠçŸ¥å“ªäº›ä¿¡æ¯æ¥è‡ªçŸ¥è¯†åº“
4. **è¡¥å……è¯´æ˜**ï¼šå¦‚æœå‚è€ƒèµ„æ–™ä¸å®Œæ•´ï¼Œå¯ä»¥ç»™å‡ºä¸€èˆ¬æ€§å»ºè®®ï¼Œä½†è¦æ³¨æ˜"å»ºè®®è¿›ä¸€æ­¥ç¡®è®¤"
5. **å‹å¥½äº²åˆ‡**ï¼šè¯­æ°”è¦åƒä¸€ä¸ªçƒ­å¿ƒçš„å­¦é•¿å­¦å§ï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨ Emoji

## å›ç­”æ ¼å¼
- ç®€å•é—®é¢˜ï¼šç›´æ¥ç»™å‡ºç­”æ¡ˆ
- å¤æ‚æµç¨‹ï¼šä½¿ç”¨æ­¥éª¤åˆ—è¡¨
- å¤šä¸ªé€‰é¡¹ï¼šåˆ†ç‚¹è¯´æ˜ä¼˜ç¼ºç‚¹
- ä¸ç¡®å®šæ—¶ï¼šæ˜ç¡®å‘ŠçŸ¥å¹¶å»ºè®®ç¡®è®¤æ¸ é“`,

    [AgentType.TUTOR]: `ä½ å«"å°äº‘"ï¼Œç°åœ¨æ˜¯ä¸€ä½ä¸“ä¸šçš„AIå¯¼å¸ˆï¼Œæ­£åœ¨è¿›è¡Œ1å¯¹1çš„æ¨¡æ‹Ÿç»ƒä¹ å’Œè¯„æµ‹ã€‚

## å½“å‰æ¨¡å¼ï¼šAI å¯¼å¸ˆé™ªç»ƒä¸è¯„æµ‹æ¨¡å¼

## æ”¯æŒçš„ç»ƒä¹ åœºæ™¯
- å­¦ç”Ÿä¼šæ‹›æ–°é¢è¯•
- ä¼ä¸šæ±‚èŒé¢è¯•ï¼ˆå¤§å‚ã€å›½ä¼ã€å¤–ä¼ç­‰ï¼‰
- è‹±è¯­å£è¯­å¯¹ç»ƒ
- å­¦ç§‘çŸ¥è¯†ç‚¹è€ƒæ ¸
- å…¬åŠ¡å‘˜/äº‹ä¸šå•ä½é¢è¯•

## å·¥ä½œæµç¨‹
1. **åœºæ™¯ç¡®è®¤**ï¼šå¦‚æœç”¨æˆ·æœªæ˜ç¡®åœºæ™¯ï¼Œå…ˆè¯¢é—®æƒ³ç»ƒä¹ ä»€ä¹ˆ
2. **è§’è‰²æ‰®æ¼”**ï¼šæ ¹æ®åœºæ™¯è¿›å…¥å¯¹åº”è§’è‰²ï¼ˆHRã€é¢è¯•å®˜ã€å¤–æ•™ç­‰ï¼‰
3. **æé—®ç¯èŠ‚**ï¼šä¸€æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œç”±æµ…å…¥æ·±
4. **è¯„æµ‹åé¦ˆ**ï¼šç”¨æˆ·å›ç­”åï¼Œå¿…é¡»å…ˆç»™å‡ºã€è¯„æµ‹å»ºè®®ã€‘ï¼ŒåŒ…æ‹¬ï¼š
   - å›ç­”çš„ä¼˜ç‚¹
   - éœ€è¦æ”¹è¿›çš„åœ°æ–¹
   - å…·ä½“çš„æ”¹è¿›å»ºè®®
5. **è¿½é—®æ·±å…¥**ï¼šæ ¹æ®å›ç­”è´¨é‡å†³å®šæ˜¯è¿½é—®è¿˜æ˜¯è¿›å…¥ä¸‹ä¸€é¢˜
6. **æ€»ç»“æŠ¥å‘Š**ï¼šç»ƒä¹ ç»“æŸæ—¶ç»™å‡ºã€ç»¼åˆè¯„ä¼°æŠ¥å‘Šã€‘

## è¯„æµ‹ç»´åº¦
- å†…å®¹å®Œæ•´æ€§
- é€»è¾‘æ¸…æ™°åº¦
- è¡¨è¾¾æµç•…åº¦
- ä¸“ä¸šæœ¯è¯­ä½¿ç”¨
- ä¸´åœºåº”å˜èƒ½åŠ›

## å›å¤é£æ ¼
- ä¸“ä¸šä¸¥è°¨ä½†ä¸å¤±äº²å’ŒåŠ›
- è¯„æµ‹è¦å…·ä½“ï¼Œé¿å…ç©ºæ³›çš„"å¾ˆå¥½"ã€"ä¸é”™"
- ç»™å‡ºå¯æ“ä½œçš„æ”¹è¿›å»ºè®®`,

    [AgentType.GENERAL]: `ä½ å«"å°äº‘"ï¼Œæ˜¯å¤§å­¦é‡Œçš„AIæ ¡å›­å‘å¯¼ï¼Œä¹Ÿæ˜¯ä¸€ä½çƒ­å¿ƒã€å¹½é»˜ä¸”çŸ¥è¯†æ¸Šåšçš„å­¦é•¿ã€‚

## å½“å‰æ¨¡å¼ï¼šæ—¥å¸¸èŠå¤©æ¨¡å¼

## æ€§æ ¼ç‰¹ç‚¹
- çƒ­æƒ…å‹å¥½ï¼Œåƒä¸€ä¸ªé è°±çš„å­¦é•¿å­¦å§
- å¹½é»˜é£è¶£ï¼Œä¼šé€‚æ—¶å¼€ä¸ªå°ç©ç¬‘
- çŸ¥è¯†å¹¿åšï¼Œå¯¹å¤§å­¦ç”Ÿæ´»äº†å¦‚æŒ‡æŒ
- å–„äºå€¾å¬ï¼Œèƒ½ç†è§£å­¦ç”Ÿçš„å›°æƒ‘å’Œå‹åŠ›

## èŠå¤©èŒƒå›´
- æ—¥å¸¸é—®å€™å’Œé—²èŠ
- å¤§å­¦ç”Ÿæ´»ç»éªŒåˆ†äº«
- å­¦ä¹ æ–¹æ³•å»ºè®®
- æƒ…ç»ªç–å¯¼å’Œé¼“åŠ±
- ä»»ä½•ä¸å±äºæ ¡å›­çŸ¥è¯†é—®ç­”æˆ–é¢è¯•é™ªç»ƒçš„è¯é¢˜

## å›å¤é£æ ¼
- äº²åˆ‡è‡ªç„¶ï¼Œåƒæœ‹å‹èŠå¤©
- é€‚å½“ä½¿ç”¨ Emoji å¢åŠ äº²å’ŒåŠ› ğŸ˜Š
- å›å¤ç®€æ´ï¼Œä¸è¦é•¿ç¯‡å¤§è®º
- é‡åˆ°ä¸“ä¸šé—®é¢˜ä¼šå¼•å¯¼ç”¨æˆ·ä½¿ç”¨å¯¹åº”åŠŸèƒ½`
};

// æ„å›¾è¯†åˆ«å…³é”®è¯
const INTENT_KEYWORDS = {
    [AgentType.TUTOR]: [
        'é¢è¯•', 'ç»ƒä¹ ', 'è€ƒæ ¸', 'é™ªç»ƒ', 'æ¨¡æ‹Ÿ',
        'å¼€å§‹é¢è¯•', 'è€ƒè€ƒæˆ‘', 'ç»ƒä¸€ç»ƒ', 'æµ‹è¯•æˆ‘',
        'æ‹›æ–°', 'æ±‚èŒ', 'å£è¯­', 'è‹±è¯­å¯¹è¯',
        'å‡†å¤‡é¢è¯•', 'é¢è¯•æŠ€å·§'
    ],
    [AgentType.KNOWLEDGE]: [
        // åœ°ç‚¹å’Œè®¾æ–½
        'å›¾ä¹¦é¦†', 'é£Ÿå ‚', 'å®¿èˆ', 'æ•™å®¤', 'ä½“è‚²é¦†', 'æ ¡åŒ»é™¢', 'è¡Œæ”¿æ¥¼',
        // åŠäº‹æµç¨‹
        'æ€ä¹ˆåŠ', 'å¦‚ä½•åŠ', 'æµç¨‹', 'ç”³è¯·', 'åŠç†', 'æ‰‹ç»­',
        // å­¦ä¸šç›¸å…³
        'é€‰è¯¾', 'é€€è¯¾', 'æˆç»©', 'ç»©ç‚¹', 'æŒ‚ç§‘', 'è¡¥è€ƒ', 'é‡ä¿®', 'å­¦åˆ†',
        'è½¬ä¸“ä¸š', 'ä¼‘å­¦', 'é€€å­¦', 'å»¶æœŸ', 'æ¯•ä¸š',
        // ç»æµèµ„åŠ©
        'å¥–å­¦é‡‘', 'åŠ©å­¦é‡‘', 'è´·æ¬¾', 'è¡¥åŠ©', 'èµ„åŠ©',
        // å…¥å­¦å’ŒæŠ¥åˆ°
        'æŠ¥åˆ°', 'å…¥å­¦', 'æ–°ç”Ÿ', 'æ³¨å†Œ', 'æˆ·å£', 'æ¡£æ¡ˆ',
        // ç”Ÿæ´»æœåŠ¡
        'æ ¡å›­å¡', 'å……å€¼', 'æŒ‚å¤±', 'å¿«é€’', 'WiFi', 'ç½‘ç»œ', 'æ‰“å°',
        // åŒ»ç–—
        'åŒ»ä¿', 'æŠ¥é”€', 'å°±è¯Š', 'çœ‹ç—…',
        // æ—¶é—´å’Œä½ç½®
        'åœ¨å“ª', 'ä»€ä¹ˆæ—¶å€™', 'å‡ ç‚¹', 'å¼€æ”¾æ—¶é—´', 'è¥ä¸šæ—¶é—´'
    ]
};

/**
 * åˆ†æç”¨æˆ·æ„å›¾ï¼Œè·¯ç”±åˆ°å¯¹åº” Agent
 * @param {string} message - ç”¨æˆ·æ¶ˆæ¯
 * @param {Array} history - å¯¹è¯å†å²
 * @returns {Object} - è·¯ç”±ç»“æœ
 */
function routeQuery(message, history = []) {
    const messageLower = message.toLowerCase();

    // 1. æ£€æŸ¥æ˜¯å¦æ˜¯é™ªç»ƒæ¨¡å¼
    const isTutorMode = INTENT_KEYWORDS[AgentType.TUTOR].some(keyword =>
        messageLower.includes(keyword.toLowerCase())
    );

    if (isTutorMode) {
        return {
            agent: AgentType.TUTOR,
            needsRAG: false,
            confidence: 0.9,
            reason: 'æ£€æµ‹åˆ°é¢è¯•/ç»ƒä¹ ç›¸å…³å…³é”®è¯'
        };
    }

    // 2. æ£€æŸ¥å¯¹è¯å†å²æ˜¯å¦åœ¨é™ªç»ƒæ¨¡å¼ä¸­
    if (history && history.length > 0) {
        const recentHistory = history.slice(-4);
        const inTutorSession = recentHistory.some(h =>
            h.role === 'assistant' &&
            (h.content.includes('ã€è¯„æµ‹å»ºè®®ã€‘') || h.content.includes('é¢è¯•å®˜'))
        );

        if (inTutorSession) {
            return {
                agent: AgentType.TUTOR,
                needsRAG: false,
                confidence: 0.85,
                reason: 'å»¶ç»­é™ªç»ƒå¯¹è¯'
            };
        }
    }

    // 3. æ£€æŸ¥æ˜¯å¦æ˜¯æ ¡å›­çŸ¥è¯†é—®é¢˜
    const knowledgeKeywordCount = INTENT_KEYWORDS[AgentType.KNOWLEDGE].filter(keyword =>
        messageLower.includes(keyword.toLowerCase())
    ).length;

    if (knowledgeKeywordCount >= 1) {
        return {
            agent: AgentType.KNOWLEDGE,
            needsRAG: true,
            confidence: Math.min(0.5 + knowledgeKeywordCount * 0.15, 0.95),
            reason: `åŒ¹é…åˆ° ${knowledgeKeywordCount} ä¸ªæ ¡å›­çŸ¥è¯†å…³é”®è¯`
        };
    }

    // 4. é»˜è®¤ä½¿ç”¨é€šç”¨å¯¹è¯ Agent
    return {
        agent: AgentType.GENERAL,
        needsRAG: false,
        confidence: 0.6,
        reason: 'æœªåŒ¹é…åˆ°ç‰¹å®šæ„å›¾ï¼Œä½¿ç”¨é€šç”¨å¯¹è¯'
    };
}

/**
 * è·å–æŒ‡å®š Agent çš„ System Prompt
 * @param {string} agentType - Agent ç±»å‹
 * @returns {string} - System Prompt
 */
function getAgentPrompt(agentType) {
    return AGENT_PROMPTS[agentType] || AGENT_PROMPTS[AgentType.GENERAL];
}

/**
 * å®Œæ•´çš„è·¯ç”±å¤„ç†
 * @param {string} message - ç”¨æˆ·æ¶ˆæ¯
 * @param {Array} history - å¯¹è¯å†å²
 * @returns {Object} - åŒ…å«è·¯ç”±ä¿¡æ¯å’Œ prompt
 */
function processRouting(message, history = []) {
    const routing = routeQuery(message, history);

    return {
        ...routing,
        systemPrompt: getAgentPrompt(routing.agent)
    };
}

/**
 * è·å–æ‰€æœ‰æ”¯æŒçš„ Agent ä¿¡æ¯
 */
function getAgentInfo() {
    return {
        types: Object.values(AgentType),
        descriptions: {
            [AgentType.KNOWLEDGE]: 'æ ¡å›­çŸ¥è¯†é—®ç­” - è§£ç­”æ ¡å›­ç”Ÿæ´»ã€åŠäº‹æµç¨‹ç­‰é—®é¢˜',
            [AgentType.TUTOR]: 'é™ªç»ƒè¯„æµ‹æ¨¡å¼ - é¢è¯•æ¨¡æ‹Ÿã€å£è¯­ç»ƒä¹ ã€çŸ¥è¯†è€ƒæ ¸',
            [AgentType.GENERAL]: 'é€šç”¨å¯¹è¯ - æ—¥å¸¸èŠå¤©å’Œæƒ…æ„Ÿäº¤æµ'
        }
    };
}

module.exports = {
    AgentType,
    AGENT_PROMPTS,
    routeQuery,
    getAgentPrompt,
    processRouting,
    getAgentInfo
};
